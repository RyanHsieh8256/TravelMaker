<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>揪團詳細頁</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="shortcut icon" href="images/logo/logo_84x50.png" type="image/png">
    <script src="js/jquery.js"></script>
    <script src="js/vue.js"></script>
</head>

<body>
    <header>
        <!-- 導覽列 -->
        <nav class="nav_Wrap">
            <section class="navBlock">
                <a href="home.html">
                    <h1 class="navLogo">
                        <img src="images/logo/logo_84x50.png" alt="TravelMaker">
                    </h1>
                </a>
                <ul class="mainNav">
                    <a href="tour.html">
                        <li>行程規劃</li>
                    </a>
                    <a href="group.html">
                        <li>揪團旅行</li>
                    </a>
                    <a href="shop.html">
                        <li>景點門票</li>
                    </a>
                    <a href="postcard.html">
                        <li>客製明信片</li>
                    </a>
                </ul>
                <ul class="navMember">
                    <li><a href="shopcart.html"><i class="bi bi-minecart-loaded"></i></a></li>
                    <li>
                        <div id="loginBoxBtn" class="loginBoxBtn">
                            <i class="bi bi-person-circle"></i><span>登入/註冊</span>
                        </div>
                        <div id="memBoxBtn" class="memBoxBtn">
                            <div class="memIcon">
                                <img id="memIcon" src="https://picsum.photos/50/50/?random=10">
                            </div>
                            <span id="memName"></span>
                        </div>
                        <!-- 登入後的會員選單-->
                        <ul class="navDropdownMenu">
                            <li class="navDropdownMenuItem">
                                <a href="mem.html">
                                    <i class="bi bi-gear"></i> 帳號設定
                                </a>
                            </li>
                            <li class="navDropdownMenuItem">
                                <a href="memtour.html">
                                    <i class="bi bi-calendar2"></i> 我的行程
                                </a>
                            </li>
                            <li class="navDropdownMenuItem">
                                <a href="memcollect.html">
                                    <i class="bi bi-bookmark-heart"></i> 我的收藏
                                </a>
                            </li>
                            <li class="navDropdownMenuItem">
                                <a href="memgro.html">
                                    <i class="bi bi-file-person"></i> 我的揪團
                                </a>
                            </li>
                            <li class="navDropdownMenuItem">
                                <a href="memorder.html">
                                    <i class="bi bi-bag"></i> 我的訂單
                                </a>
                            </li>
                            <li class="navDropdownMenuItem" id="logOutBtn">
                                <i class="bi bi-door-closed"></i> 登出
                            </li>
                        </ul>
                    </li>
                    <li>
                        <div class="burger-toggle">
                            <i class="bi bi-list"></i>
                        </div>
                    </li>
                </ul>
            </section>
        </nav>
        <!-- 漢堡 -->
        <div class="navPage">
            <button class="navPage--close">
                <span class="close_line"></span>
                <span class="close_line"></span>
            </button>
            <div class="navPage_wrap">
                <!--     <div class="navPage_header"></div> -->
                <div class="navPage_content">
                    <!--       <div class="navPage_logo"></div> -->
                    <div class="navPage_box">
                        <nav class="navPage_nav">
                            <ul class="navPage_list">
                                <li class="navPage_item">
                                    <div class="navPage_header">
                                        <span class="navPage_header--num">01</span>
                                        <span class="navPage_header--line"></span>
                                    </div>
                                    <div class="navPage_text">
                                        <span class="navPage_text--en">Plan journey</span>
                                        <span class="navPage_text--ch">行程規劃</span>
                                    </div>
                                    <a href="tour.html" class="navPage_link"></a>
                                </li>
                                <li class="navPage_item">
                                    <div class="navPage_header">
                                        <span class="navPage_header--num">02</span>
                                        <span class="navPage_header--line"></span>
                                    </div>
                                    <div class="navPage_text">
                                        <span class="navPage_text--en">All together</span>
                                        <span class="navPage_text--ch">揪團旅行</span>
                                    </div>
                                    <a href="group.html" class="navPage_link"></a>
                                </li>
                                <li class="navPage_item">
                                    <div class="navPage_header">
                                        <span class="navPage_header--num">03</span>
                                        <span class="navPage_header--line"></span>
                                    </div>
                                    <div class="navPage_text">
                                        <span class="navPage_text--en">Shop</span>
                                        <span class="navPage_text--ch">景點門票</span>
                                    </div>
                                    <a href="shop.html" class="navPage_link"></a>
                                </li>
                                <li class="navPage_item">
                                    <div class="navPage_header">
                                        <span class="navPage_header--num">04</span>
                                        <span class="navPage_header--line"></span>
                                    </div>
                                    <div class="navPage_text">
                                        <span class="navPage_text--en">Postcard</span>
                                        <span class="navPage_text--ch">客製明信片</span>
                                    </div>
                                    <a href="postcard.html" class="navPage_link"></a>
                                </li>
                            </ul>
                        </nav>

                    </div>
                </div>
            </div>
        </div>
        <!-- 登入表單 -->
        <div class="froLoginBG" id="froLoginBG">
            <section class="froLoginBlock" id="froLoginBlock">
                <!-- 取消按鈕 -->
                <div class="froLoginCancel">
                    <button><i class="bi bi-x-circle-fill"></i></button>
                </div>
                <!-- 註冊/登入 -->
                <div class="froLoginSwitch">
                    <div class="froLoginSwitch_btn froLoginSwitch_active" @click="content='login',content2='loginbear'">
                        登入
                    </div>
                    <div class="froLoginSwitch_btn" @click="content='signin',content2='singinbear'">
                        註冊
                    </div>
                </div>
                <!-- 表單區 -->
                <transition name="frologintransition" mode="out-in">
                    <keep-alive>
                        <component :is='content'></component>
                    </keep-alive>
                </transition>
                <transition name="mascottransition">
                    <component :is='content2'></component>
                </transition>
            </section>
        </div>
        <section class="l-full groupdetailCoverInfo">
            <div class="l-medium groupdetailCoverInfo_wrap">
                <div class="row">
                    <div class="col-12 col-md-6 cover_wrap">
                        <div class="cover">
                            <img src="./images/groupdetail/groupdetailCoverInfo_cover.jpg" alt="">
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="info">
                            <div class="initiatorPic"><img src="https://picsum.photos/50/50/?random=10"></div>
                            <div class="initiator">我是團主</div>
                        </div>
                        <h3 class="card_title">台東秘境嘉明湖三日登山行程(含山屋申請)｜發現天使的眼淚</h3>
                        <p class="cardText">
                            想一探台東秘境"嘉明湖"真實面貌，就必須爬上海拔3000多公尺的高山，三日裡背負重裝，由專業高山嚮導帶領從池上出發3天2夜，沿途中，不斷地與自己對話，行程提供代為申請山屋或營帳住宿，加上免背免備公器公糧服務，讓您能保存更多的體力去應付前往嘉明湖三叉向陽山的登山路程。當親眼見到『天使的眼淚-嘉明湖』之美，神秘又遙遠的台灣美景，讓人學會敬畏與謙卑。越美的風景，越要觀察，保持神秘，她永遠在心中，隱藏在高山中湛藍的絕美湖泊景致。
                        </p>
                        <div class="spot_wrap">
                            <div class="spot">剩餘名額<span class="spotNum">5</span>位</div>
                        </div>
                        <div class="card_date">
                            <p class="card_time card_time--start">
                                <span>出發日期：</span>
                                <span class="departureDate">2022/02/20</span>
                            </p>
                            <p class="card_time card_time--end">
                                <span>回程日期：</span>
                                <span class="returnDate">2022/02/25</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </header>
    <main>
        <!-- 團的旅程資訊和留言區 -->
        <section class="l-full groupdetailInfo">
            <div class="l-medium groupdetailInfo_wrap">
                <div class="row">
                    <div class="col-12 col-md-8">
                        <div class="second-title">
                            <span>Information</span>
                            旅程資訊
                        </div>
                        <div class="tourInfo">
                            <div class="timeline">
                                <!-- 時間軸tab按鈕 -->
                                <div class="timeline_nav">
                                    <div class="timeline_box">
                                    </div>
                                </div>
                                <ul class="timeline_list">
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4 messageScrollbar">
                        <div class="second-title messageTitle">
                            <span>Message</span>
                            <div class="pic">
                                <img src="./images/groupdetail/groupdetailMessageBear.gif" alt="">
                            </div>
                        </div>
                        <div class="message">
                            <div class="leaveMessage">
                                <textarea name="" cols="10" rows="5" id="inputBox"></textarea>
                                <button id="leaveMessageBtn">我要<br>留言</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <button class="joinBtn">我要<br>參團</button>
    </main>
    <footer class="footer_Wrap">
        <section class="footerBlock">
            <ul class="footerMedia">
                <a href="">
                    <li><i class="bi bi-facebook"></i></li>
                </a>
                <a href="">
                    <li><i class="bi bi-instagram"></i></li>
                </a>
                <a href="">
                    <li><i class="bi bi-line"></i>
                        </ion-icon>
                    </li>
                </a>
            </ul>
            <ul class="footerContect">
                <li><i class="bi bi-telephone"></i>電話:03-1234567</li>
                <li><i class="bi bi-envelope"></i>服務信箱:<a href="mailto:abc12345@gmail.com">abc12345@gmail.com</a></li>
                <li><i class="bi bi-clock"></i>營業時間:09:00 ~ 18:00(一)~(五)</li>
                <li><i class="bi bi-pin-map"></i>地址:桃園市桃園區中正路99999號</li>
            </ul>
            <ul class="footerTerms">
                <a href="">
                    <li>服務條款</li>
                </a><a href="">
                    <li>購物條款</li>
                </a><a href="">
                    <li>付款方式</li>
                </a>
            </ul>
            <p class="footerCopyRight">&copy;copy right by nobody .Please don't sue me.</p>
        </section>
    </footer>

    <!-- 提醒視窗的架構 -->
    <div class="alertBG">
        <div class="alertBG_wrap">
            <button class="alertBG_closeBtn">
                <i class="bi bi-x-circle-fill"></i>
            </button>
            <p class="alertBG_content"></p>
        </div>
    </div>

    <!-- at designated point, show the joinBtn -->
    <script>
        $(function () {
            $(window).scroll(function () {
                let scrollTop = $(window).scrollTop();
                // console.log(scrollTop);
                let showPoint = $('.spot_wrap').offset().top;
                // console.log(showPoint);
                if (scrollTop >= showPoint) {
                    $('.joinBtn').addClass('showJoinBtn');
                } else {
                    $('.joinBtn').removeClass('showJoinBtn');
                }
            });
        });
    </script>

    <!--click and show the alert  -->
    <script>
        let joinBtn = document.querySelector('.joinBtn');
        let alertBG_content = document.querySelector('.alertBG_content');

        function showAlertBG() {
            alertBG.style.display = 'block';
            alertBG_content.innerText = '已成功參加此團，請至會員中心「我的揪團」查看紀錄';
        };

        joinBtn.addEventListener('click', showAlertBG);
    </script>

    <!-- 關閉提醒視窗 -->
    <script>
        let alertBG_closeBtn = document.querySelector('.alertBG_closeBtn');
        let alertBG = document.querySelector('.alertBG');

        function close() {
            alertBG.style.display = "none";
            window.location.href = './group.html';
        }
        alertBG_closeBtn.addEventListener('click', close);
    </script>

    <!-- 行程天數切換 -->
    <script>
        function changeTab() {
            tabs = document.querySelectorAll('.timeline_tab');
            pages = document.querySelectorAll('.timeline_page');
            tabs.forEach(tab => tab.addEventListener('click', changePage));

            function changePage(e) {
                tabs.forEach(tab => tab.classList.remove('timeline_tab--active'));
                pages.forEach(page => page.classList.remove('timeline_page--active'));

                let curPage = Number(e.target.dataset['tab']);
                let tab = document.querySelector(`.timeline_tab--${curPage}`);
                let page = document.querySelector(`.timeline_page--${curPage}`);

                if (!tab || !page) return;
                tab.classList.add('timeline_tab--active');
                page.classList.add('timeline_page--active');
            }
        }

        changeTab();
    </script>

    <!-- 從group頁面帶資料過來 -->
    <script>
        let groNo = location.search.split('?')[1].split('=')[1];

        groupData();
        function groupData() {
            $.ajax({
                type: 'GET',
                url: `./phps/groupdetailData.php?groNo=${groNo}`,
                dataType: 'json',
                success: function (res) {
                    console.log(res);
                    // 串接封面照片
                    let coverImg;
                    coverImg = $('.cover img');
                    coverImg.attr('src', `images/groImg/${res[0].groImg}`);
                    // 串接團主圖片和名字
                    let initiatorPic;
                    initiatorPic = $('.initiatorPic img');
                    initiatorPic.attr('src', `images/memIcon/${res[0].memicon}`);
                    let initiator;
                    initiator = $('.initiator');
                    initiator.text(res[0].memName);
                    // 串接團的標題和內容描述
                    let card_title;
                    card_title = $('.card_title');
                    card_title.text(res[0].groName);
                    let cardText;
                    cardText = $('.cardText');
                    cardText.text(res[0].groContent);
                    //串接剩餘名額
                    let spotNum;
                    spotNum = $('.spotNum');
                    spotNum.text(res[0].quota);
                    //串接出發日期和回程日期
                    let departureDate;
                    departureDate = $('.departureDate');
                    departureDate.text(res[0].groStartDate);
                    let returnDate;
                    returnDate = $('.returnDate');
                    returnDate.text(res[0].groEndDate);
                }
            });
        }
    </script>

    <!-- 按我要參團後，把memNo和groNo插入資料庫的gromem表格裡 -->
    <script>
        function addData() {
            // console.log(123);
            let memberData = localStorage.getItem('memData');
            let groupdetailMemInfo = JSON.parse(memberData).memNo;
            let dataToBack = `memNo=${groupdetailMemInfo}&groNo=${groNo}`;

            console.log(groupdetailMemInfo); //5
            console.log(dataToBack);
            $.ajax({
                type: 'POST',
                url: './phps/groupdetailAddData.php',
                data: `${dataToBack}`,
                dataType: 'text',
                success: function (res) {
                    console.log(res);
                    groupData();
                }
            });

        }
        $('.joinBtn').on('click', addData);
    </script>

    <!-- 抓行程景點資料 -->
    <script>
        function fetchData() {
            curGroup = +groNo;
            fetch(`./phps/fetchJour.php?group=${curGroup}`).then(res => res.json())
                .then(data => {

                    // 抓該行程的天數

                    let dayArr = [];
                    let dayNum = Math.max(...data.map(jour => +jour.journeySpotDay));


                    for (let i = 1; i <= dayNum; i++) {
                        let theData = data.filter(jour => jour.journeySpotDay == i);
                        dayArr.push(theData);
                    }


                    // 寫入session storage
                    sessionStorage.clear();
                    dayArr.forEach((day, i) => {
                        // 整理陣列裡物件順序
                        day.sort((a, b) => +a.sequence - +b.sequence);
                        sessionStorage.setItem(`day${i + 1}`, JSON.stringify(day));
                    });

                    displaySide(curGroup, dayNum);

                })

        }
        fetchData();

        // 呈現該行程景點
        function displaySide(no, num) {
            let timelineBox = document.querySelector('.timeline_box');
            let timelineList = document.querySelector('.timeline_list');
            let oldPages = timelineList.children;
            [...oldPages].forEach(page => page.remove());

            let tabs = '';

            for (let i = 1; i <= num; i++) {
                let dayData = JSON.parse(sessionStorage.getItem(`day${i}`));

                let timelinePage = document.createElement('div');
                timelinePage.className = `timeline_page timeline_page--${i} ${i == 1 ? 'timeline_page--active' : ''}`;
                timelineList.append(timelinePage);

                tabs += `<div class="timeline_tab timeline_tab--${i} ${i == 1 ? 'timeline_tab--active' : ''}" data-tab="${i}">第${i}天</div>`;



                let items = dayData.map(day => {
                    let { spotNo, sequence, spotName, spotImg } = day;

                    let spotItem = `
            <li class="timeline_item tourBuild_item" data-no="${spotNo}" drag-handle>
            <div class="timeline_text">
                <div class="timeline_num">${sequence}</div>
                <div class="timeline_name">${spotName}</div>
            </div>
            <div class="timeline_img">
                <img src="${spotImg}" alt="">
            </div>
            </li>
            `
                    return spotItem;
                }).join('');


                timelinePage.innerHTML = items;
            }

            timelineBox.innerHTML = tabs;

            changeTab();
        }
    </script>

    <script>
        // 共用
        // 行程天標籤的拖動
        const dragSlide = function () {

            const infoList = document.querySelector('.timeline_box');

            let clicked = false;
            let startX;
            let xoffest;


            const end = () => {
                clicked = false;

            }

            const start = (e) => {
                clicked = true;
                startX = e.pageX || e.touches[0].pageX - infoList.offsetLeft;
                xoffest = infoList.scrollLeft;
            }

            const move = (e) => {
                if (!clicked) return;

                e.preventDefault();
                const x = e.pageX || e.touches[0].pageX - infoList.offsetLeft;
                const dist = (x - startX);
                infoList.scrollLeft = xoffest - dist;
            }


            infoList.addEventListener('mousedown', start);
            infoList.addEventListener('touchstart', start);

            infoList.addEventListener('mousemove', move);
            infoList.addEventListener('touchmove', move);

            infoList.addEventListener('mouseleave', end);
            infoList.addEventListener('mouseup', end);
            infoList.addEventListener('touchend', end);

        }

        dragSlide();
    </script>

    <script src="js/burger.js"></script>
    <script src="js/forlogin.js"></script>
    <script src="js/loading.js"></script>
    <script src="js/message.js"></script>
</body>

</html>